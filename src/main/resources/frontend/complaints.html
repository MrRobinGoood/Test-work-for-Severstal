<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Complaints Details</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
<div class="container">
    <button id="backToPurchaseObjects" class="btn btn-secondary">Back to Purchase Objects</button>

    <h2>Purchase Object Details</h2>
    <p>Purchase Object ID: <span id="purchaseObjectId"></span></p>
    <p>Product Type: <span id="productType"></span></p>
    <p>Product Title: <span id="productTitle"></span></p>
    <p>Product Count: <span id="productCount"></span></p>
    <p>Measure Unit: <span id="measureUnit"></span></p>
    <p>Price per Unit: <span id="pricePerUnit"></span></p>
    <p>Total Price: <span id="totalPrice"></span></p>
    <p>Currency Type: <span id="currencyType"></span></p>
    <p>Has Complaints: <span id="hasComplaints"></span></p>
    <p>Delivery Id: <span id="deliveryId"></span></p>
    
    <h3>Complaints</h3>
    <table class="table table-striped" id="complaintsTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Complaint Count</th>
                <th>Percent of Complaints</th>
                <th>Price Per All Complaint Count</th>
                <th>Reason</th>
                <th>Commentary</th> <!-- Добавленный столбец для комментариев -->
            </tr>
        </thead>
        <tbody>
            <!-- Здесь будут динамически добавляться строки -->
        </tbody>
    </table>
    <div class="form-group">
        <label for="complaintId">Complaint ID:</label>
        <input type="number" class="form-control" id="complaintId" min="0" readonly>
    </div>
    <div class="form-group">
        <label for="complaintCount">Complaint Count:</label>
        <input type="number" class="form-control" id="complaintCount" step="0.0001" min="0">
    </div>
    <div class="form-group">
        <label for="reasonSelect">Reason:</label>
        <select class="form-control" id="reasonSelect"></select>
    </div>
    <div class="form-group">
        <label for="commentInput">Comment:</label>
        <textarea class="form-control" id="commentInput" maxlength="1000"></textarea>
    </div>
    <button id="saveButton" class="btn btn-primary">Save complaint</button>
    <button id="resetButton" class="btn btn-secondary">Reset</button>
</div>

<script>
$(document).ready(function() {
    var purchaseObjectId = ''; // ID текущего объекта покупки
    var deliveryId = '';
    var isReasonReady = true;
    var isComplaintCountReady = false;

    function loadPurchaseObjectDetails(id) {
        $.ajax({
            url: 'http://localhost:8081/purchase-objects/' + id,
            method: 'GET',
            success: function(response) {
                purchaseObjectId = response.id;
                $('#purchaseObjectId').text(response.id);
                $('#productType').text(response.product.productType.title);
                $('#productTitle').text(response.product.title);
                $('#productCount').text(response.productCount);
                $('#measureUnit').text(response.measureUnit.title);
                $('#pricePerUnit').text(parseFloat(response.pricePerUnit).toFixed(3));
                $('#totalPrice').text((parseFloat(response.productCount) * parseFloat(response.pricePerUnit)).toFixed(3));
                $('#currencyType').text(response.currencyType.title);
                $('#hasComplaints').text(response.hasComplaints? 'Yes' : 'No');
                $('#deliveryId').text(response.deliveryId);
                deliveryId = response.deliveryId;

                loadComplaints(id);
            },
            error: function(error) {
                console.error('Ошибка при загрузке деталей объекта покупки:', error);
            }
        });
    }

    function loadComplaints(purchaseObjectId) {
        $.ajax({
            url: 'http://localhost:8081/purchase-objects/' + purchaseObjectId + '/complaints',
            method: 'GET',
            success: function(response) {
                var tbody = $('#complaintsTable tbody');
                tbody.empty();
                response.complaints.forEach(complaint => {
                    var row = $('<tr>');
                    row.append('<td>' + complaint.id + '</td>');
                    row.append('<td>' + complaint.complaintCount.toFixed(1) + '</td>');
                    row.append('<td>' + complaint.percentComplaintCount.toFixed(1) + '%</td>');
                    row.append('<td>' + complaint.pricePerAllComplaintCount.toFixed(2) + '</td>');
                    row.append('<td>' + complaint.reason.title + '</td>');
                    row.append('<td>' + (complaint.commentary? complaint.commentary : '-') + '</td>');
                    tbody.append(row);
                });
            },
            error: function(error) {
                console.error('Ошибка при загрузке жалоб:', error);
            }
        });
    }

    function loadReasons() {
    $.ajax({
        url: 'http://localhost:8081/reasons',
        method: 'GET',
        success: function(response) {
            var select = $('#reasonSelect');
            select.empty(); // Очищаем предыдущие значения
            // Добавляем пустое значение в начало списка
            var emptyOption = $('<option>').val('').text('Выберите причину...');
            select.prepend(emptyOption); // Добавляем пустую опцию в начало списка
            response.forEach(reason => {
                var option = $('<option>').val(reason.id).text(reason.title);
                select.append(option);
            });
        },
        error: function(error) {
            console.error('Ошибка при загрузке причин:', error);
        }
    });
    }

    loadReasons();

    var urlParams = new URLSearchParams(window.location.search);
    var purchaseObjectIdFromUrl = urlParams.get('id');
    if (purchaseObjectIdFromUrl) {
        loadPurchaseObjectDetails(purchaseObjectIdFromUrl);
    } else {
        console.log("ID объекта объекта закупки не указан");
    }

    loadComplaints(purchaseObjectIdFromUrl); // Предполагается, что purchaseObjectIdFromUrl определен где-то выше

    $('#backToPurchaseObjects').on('click', function() {
        window.location.href = 'delivery-details.html?id=' + deliveryId;
    });



    function allChecked() {
        // Инициализация состояния кнопки при загрузке страницы
        if (!$('#complaintCount').val() || $('#reasonSelect').val() === '') { // Условие осталось прежним
                $('#saveButton').prop('disabled', true);
            } else {
                $('#saveButton').prop('disabled', false);
            }
    
}

allChecked();


    // Отслеживание изменения в поле complaintCount
    $('#complaintCount').on('input', function() {
        allChecked();
        });

    // Отслеживание изменения значения в combobox
    $('#reasonSelect').on('change', function() {
        allChecked();
       
    });

    

    $('#saveButton').on('click', function() {
    var decimalValue = $('#decimalInput').val();
    var selectedReasonId = $('#reasonSelect').val();
    var comment = $('#commentInput').val();

    // Здесь должен быть ваш код для отправки данных на сервер
    // Например:
    $.ajax({
        url: 'http://localhost:8081/save-data', // Замените на актуальный URL для сохранения данных
        method: 'POST',
        data: JSON.stringify({ decimalValue: decimalValue, reasonId: selectedReasonId, comment: comment }),
        contentType: 'application/json',
        success: function(response) {
            console.log('Данные успешно сохранены:', response);
        },
        error: function(error) {
            console.error('Ошибка при сохранении данных:', error);
        }
    });
});

});
</script>
</body>
</html>
